# We wire Lefthook into git so every commit reruns our pnpm lint story before history changes.
# This lets teammates catch Biome or TypeScript regressions while context is fresh and fixes stay cheap.

pre-commit:
  # We intercept pre-commit so every snapshot benefits from the same quality gates as CI.
  jobs:
    - name: biome-fix
      # We auto-apply Biome fixes first so formatting nits disappear before the rest of the hooks run.
      # stage_fixed re-adds any touched files so the subsequent jobs lint the rewritten sources we now intend to commit.
      run: pnpm run lint:biome:fix
      stage_fixed: true
    - name: code-health
      # We bundle Biome + TypeScript here to surface lint and structural issues together; running them in parallel keeps feedback tight.
      group:
        parallel: true
        jobs:
          - name: biome
            # We lint directly with pnpm so contributors do not need a global Biome install.
            # This mirrors `pnpm lint:biome`, ensuring hook output matches local reproduction steps.
            run: pnpm run lint:biome
          - name: typescript
            # We rely on the dedicated typecheck script so both tsconfig targets stay aligned with CI.
            # Keeping it beside Biome ensures structural regressions surface even when lint passes.
            run: pnpm run typecheck
    - name: vitest
      # We only kick off Vitest after code-health succeeds so test noise never hides lint/type failures.
      # We lean on Vitest's built-in --changed flag so this job only exercises specs tied to our current diff while manual pnpm test runs still cover the full suite.
      run: pnpm test --changed

prepare-commit-msg:
  # We hand control to Commitizen during message preparation so we co-author conventional commits through the guided wizard instead of free-typing guesswork.
  jobs:
    - name: commitizen
      # We mark this job as interactive so lefthook lets the wizard borrow our terminal and collect answers instead of hanging silently.
      # Commitizen inspects the LEFTHOOK flag, so we clear it to zero to stop the wizard from thinking the hook recursively invoked itself.
      interactive: true
      env:
        LEFTHOOK: 0
      # The helper script inspects Gitâ€™s arguments so we only launch Commitizen when no message exists yet, letting -m/-F or merge commits remain non-interactive.
      run: ./scripts/prepare-commit-msg.sh "$1" "$2" "$3"

commit-msg:
  # We lint commit messages so our history stays compatible with changelog tooling and code review stays readable at a glance.
  jobs:
    - name: commitlint
      # We ask commitlint to inspect the message file git passes in so contributors get fast feedback before history lands.
      # The first argument from git is the path to the temporary commit message, which Lefthook forwards as $1 for us.
      run: pnpm exec commitlint --edit "$1"
